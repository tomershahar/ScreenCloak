# M4 Design — Menu Bar Icon, API Key Detection, Windows Packaging

**Date:** 2026-02-14
**Status:** Approved

---

## Goal

Three features to complete before beta:
1. Menu bar / system tray icon (macOS + Windows)
2. API key detection (implement the existing stub, free for all users)
3. Windows packaging (PyInstaller `.exe` + Inno Setup installer)

---

## Feature 1: Menu Bar / System Tray Icon

### Library

`pystray` — cross-platform (macOS + Windows), uses PIL for icon rendering. One implementation works on both platforms.

### Icon States

| State | Colour | Trigger |
|-------|--------|---------|
| Idle | Grey circle | Default — running, no recent detections |
| Clean | Green circle | After a scan with no detections (fades to grey after 3s) |
| Alert | Red circle | Detection fired — stays red for 10s or until dismissed |

### Menu

```
ScreenCloak          (disabled title)
──────────
● Running           ← toggles Pause/Resume on click
Detections: 0       ← live counter, non-clickable
──────────
Quit
```

### Architecture

- `ui/tray.py` — new file, runs `pystray` loop in a background thread
- Exposes two methods to `main.py`:
  - `set_state(state: Literal["idle", "clean", "alert"])` — updates icon colour
  - `increment_detections()` — bumps the counter in the menu
- Pause/Resume controlled via a `threading.Event` shared between tray thread and scan loop
- `main.py` checks the pause event at the top of each scan iteration

---

## Feature 2: API Key Detection

### What Changes

`detectors/api_keys.py` — remove the stub and paid-tier gate, implement real detection.

### Detection Logic

1. Load patterns from `data/api_patterns.json` at `__init__`
2. Combine all OCR text into one string
3. For each service pattern, run regex search
4. On match: `confidence = 0.92`, `action = "blur"`
5. Return one `DetectionResult` per matched key

### Confidence Rationale

API key regexes have fixed prefixes + fixed lengths + restricted charsets — specific enough that 0.92 base confidence is justified without additional context signals (unlike credit cards which need expiry/CVV nearby).

### Config Change

`config.yaml`: flip `detection.api_keys.enabled` default from `false` to `true`.

### Patterns (already in `data/api_patterns.json`)

AWS, GitHub, Stripe, OpenAI, Anthropic, Google, Slack, Twilio, SendGrid, DigitalOcean, NPM, Discord, and 2 others (14 total).

---

## Feature 3: Windows Packaging

### Toolchain

- **PyInstaller** — same as macOS, produces `dist/ScreenCloak.exe`
- **Inno Setup** — wraps the exe into a standard Windows installer with uninstaller

### Tesseract

Not bundled. User installs separately from UB-Mannheim builds:
`https://github.com/UB-Mannheim/tesseract/wiki`

Default install path: `C:\Program Files\Tesseract-OCR\tesseract.exe`

### `bundle_paths.py` Windows additions

In frozen mode on Windows:
- `config_dir` → `%APPDATA%\ScreenCloak\`
- `log_dir` → `%APPDATA%\ScreenCloak\logs\`
- `tesseract_cmd` → `C:\Program Files\Tesseract-OCR\tesseract.exe` if it exists, else `None` with a clear startup error

### New Files

| File | Purpose |
|------|---------|
| `ScreenCloak-Windows.spec` | PyInstaller config for Windows (no macOS entitlements/LSUIElement) |
| `scripts/build_windows.bat` | One-command build: PyInstaller + Inno Setup |
| `scripts/screencloak.iss` | Inno Setup script — installer UI, shortcuts, uninstaller |

### Build Environment

Windows builds must run on a Windows machine (PyInstaller does not support cross-compilation). The build produces `dist/ScreenCloak-1.0.0-Setup.exe`.

---

## Out of Scope

- Linux packaging (not enough streamer demand to justify now)
- Auto-updater (future milestone)
- License key / paid tier gating (API keys are free for all users)
- macOS code signing (no Apple Developer account)
